<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
  <meta name="Robots" content="index,follow"/>
  <meta http-equiv="content-language" content="zh-TW" />
  <title>夏天廣告回報系統</title>

  <%= stylesheet_link_tag    "application", :media => "all" %>
  <link rel="stylesheet" media="screen and (max-width: 543px)" href="/assets/front/mobile"/>
  <link rel="stylesheet" media="screen and (min-width: 544px) and (max-width: 896px)" href="/assets/front/tablet" />
  <link rel="stylesheet" media="screen and (min-width: 897px)" href="/assets/front/desktop"/>
  <link rel="StyleSheet" href="/plugin/tagit/css/jquery.tagedit.css" type="text/css" media="all"/>

  <%= javascript_include_tag "application" %>
  <script type="text/javascript" src="/plugin/tagit/js/jquery.autoGrowInput.js"></script>
  <script type="text/javascript" src="/plugin/tagit/js/jquery.tagedit.js"></script>

  <%= csrf_meta_tags %>
</head>
<body>
  <% if (user_signed_in?) %>
  <section id="wrapper">
    <aside>
      <section id="search">
        <div>
          <input type="text" id="search-text">
          <input type="button" id="search-button">
        </div>
      </section>
      <!--search-->

      <section id="info">
        <a id="info-edit" href="<%= edit_user_registration_path %>"><img src="/images/edit.png"></a>
        <div class="photo">
          <div class="img-border"><img src="/images/avator.jpg"></div>
        </div>
        <div id="account">
          <span class="name"><%= current_user.username %></span><br>
          <span class="email"><%= current_user.email %></span>
        </div>
      </section>
      <!--info-->

      <section id="topic">
        <h6>最新動態</h6>
        <div class="ticket">
          <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
              <td class="topic-name"><a href="#">近期回報</a></td>
              <td class="notice"><span>2</span></td>
            </tr>
          </table>
        </div>

        <div class="ticket">
          <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
              <td class="topic-name"><a href="#">最新留言</a></td>
              <td class="notice"><span>1</span></td>
            </tr>
          </table>
        </div>

        <div class="ticket">
          <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
              <td class="topic-name"><a href="/tickets">依優先排序</a></td>
              <td class="notice"></td>
            </tr>
          </table>
        </div>

        <div class="ticket">
          <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
              <td class="topic-name"><a href="/tickets?order=createDESC">依時間排序</a></td>
              <td class="notice"></td>
            </tr>
          </table>
        </div>

        <h6>我的訂閱
          <div class="tool"><a id="check-button">check</a><a id="del-button">delete</a><a id="add-button">Add</a></div>
        </h6>

        <div id="topic-add">
          <form accept-charset="UTF-8" action="/tickets" method="post">
            <div style="margin:0;padding:0;display:inline">
              <input name="utf8" type="hidden" value="✓">
              <input name="authenticity_token" type="hidden" value="MtCsP1oggzzLksDJ4RZHdtPlEjiJNkbdDj3Gmmso15w=">
            </div>

            <input type="text" id="topic-text">
            <input name="subscribe[topic]" type="text" id="topic-value">
            <input type="button" id="topic-button" value="增加">
          </form>
        </div>

        <% @subscribes.each do |subscribe| %>
        <div class="ticket" data-del="<%= subscribe.id %>">
          <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
              <td class="del"><%= link_to '', ticket_topic_path(subscribe), :method => :delete, :remote => true %></td>
              <td class="topic-name"><a href="<%= ticket_topic_path(subscribe.topic_id) %>"><%= subscribe.name %></a></td>
              <td class="notice"><% if subscribe.count>0 %><span><%= subscribe.count %></span><% end %></td>
            </tr>
          </table>
        </div>
        <% end %>
      </section>
      <!--topic-->
    </aside>

    <article>
      <header>
        <table width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td id="aside-ctrl"><a href="#"><img src="/images/nav.png"></a></td>
            <td><h1><a href="/">夏天廣告回報系統</a></h1></td>
            <td class="tool">
              <a href="#" id="tool-ctrl"><img src="/images/set.png"></a>
              <div id="tool-list"><%= link_to (image_tag("/images/logout.png")+"登出"), destroy_user_session_path, method: :delete %> <%= link_to (image_tag("/images/tag.png")+"專案管理") ,topics_path %> <%= link_to (image_tag("/images/user.png")+"使用者列表") ,admin_users_path, :id => "user-list" %></div>
            </td>
          </tr>
        </table>
      </header>

      <%= yield %>

    </article>
  </section>

  <% else %>

  <%= yield %>

  <% end %>
</body>

<script type="text/javascript">
/* search description from tickets */
$("#search-button").click(function(){
  var queryString = $("#search-text").val();
  if (queryString) {
    document.location.href = "/tickets/query/" + queryString;
  }
});
$("#search-text").keydown(function(event){
  if (event.keyCode == 13){
    $("#search-button").trigger('click');
  }
});


/* autocomplete subscribing topic */
$.ajax({
  async: false,
  url: "/getTopics",
  dataType: 'json',
  complete: function (XMLHttpRequest, textStatus) {
    var topics = $.parseJSON(XMLHttpRequest.responseText);

    $("#topic-text").autocomplete({
      source: topics,
      minLength: 0,
      change: function (event, ui) { $("#topic-value").val(JSON.stringify(ui.item)); }
    })
    .focus(function() {
      $(this).autocomplete('search', $(this).val())
    })

    $("#ticketTopic").autocomplete({
      source: topics,
      minLength: 0,
      change: function (event, ui) { $("#ticket_topic").val(JSON.stringify(ui.item)); }
    })
    .focus(function() {
      $(this).autocomplete('search', $(this).val())
    })
  }
});
</script>

</html>
